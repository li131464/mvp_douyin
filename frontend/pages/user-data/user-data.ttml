<view class="container">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <view class="header">
    <view class="header-left" bind:tap="goBack">
      <text class="back-icon">â€¹</text>
      <text class="back-text">è¿”å›</text>
    </view>
    <view class="header-title">æˆ‘çš„æ•°æ®</view>
    <view class="header-right"></view>
  </view>

  <!-- ç”¨æˆ·ä¿¡æ¯ -->
  <view class="user-info" tt:if="{{userInfo}}">
    <image class="avatar" src="{{userInfo.avatarUrl}}" mode="aspectFill"></image>
    <view class="user-details">
      <text class="nickname">{{userInfo.nickName}}</text>
      <text class="data-source">{{dataSource}}</text>
    </view>
  </view>

  <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
  <view class="tabs">
    <view 
      class="tab-item {{activeTab === 'videos' ? 'active' : ''}}"
      data-tab="videos"
      bind:tap="switchTab"
    >
      <text class="tab-text">æˆ‘çš„è§†é¢‘</text>
      <text class="tab-count" tt:if="{{videos.length > 0}}">({{videos.length}})</text>
    </view>
    <view 
      class="tab-item {{activeTab === 'comments' ? 'active' : ''}}"
      data-tab="comments"
      bind:tap="switchTab"
    >
      <text class="tab-text">æˆ‘çš„è¯„è®º</text>
      <text class="tab-count" tt:if="{{comments.length > 0}}">({{comments.length}})</text>
    </view>
    <view 
      class="tab-item {{activeTab === 'messages' ? 'active' : ''}}"
      data-tab="messages"
      bind:tap="switchTab"
    >
      <text class="tab-text">ç§ä¿¡æ¶ˆæ¯</text>
      <text class="tab-count" tt:if="{{messages.length > 0}}">({{messages.length}})</text>
    </view>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="content">
    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-container" tt:if="{{loading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- è§†é¢‘åˆ—è¡¨ -->
    <view class="video-list" tt:if="{{activeTab === 'videos' && !loading}}">
      <view 
        class="video-item"
        tt:for="{{videos}}"
        tt:key="item_id"
        data-index="{{index}}"
        bind:tap="viewVideoDetail"
      >
        <view class="video-cover">
          <image src="{{item.cover}}" mode="aspectFill"></image>
          <view class="video-duration">{{formatDuration(item.duration)}}</view>
          <view class="video-top" tt:if="{{item.is_top}}">ç½®é¡¶</view>
        </view>
        <view class="video-info">
          <text class="video-title">{{item.title}}</text>
          <view class="video-stats">
            <text class="stat-item">æ’­æ”¾ {{formatNumber(item.statistics.play_count)}}</text>
            <text class="stat-item">ç‚¹èµ {{formatNumber(item.statistics.digg_count)}}</text>
            <text class="stat-item">è¯„è®º {{formatNumber(item.statistics.comment_count)}}</text>
          </view>
          <text class="video-time">{{formatTime(item.create_time)}}</text>
        </view>
      </view>
      
      <!-- è§†é¢‘åˆ—è¡¨ä¸ºç©º -->
      <view class="empty-state" tt:if="{{videos.length === 0 && !videoLoading}}">
        <text class="empty-icon">ğŸ“¹</text>
        <text class="empty-text">{{videoError || 'æš‚æ— è§†é¢‘æ•°æ®'}}</text>
        <text class="error-hint" tt:if="{{videoError && videoError.includes('ç½‘ç»œ')}}">
          ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œå·²åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ•°æ®æ¨¡å¼
        </text>
      </view>
      
      <!-- åŠ è½½æ›´å¤š -->
      <view class="load-more" tt:if="{{videoLoading}}">
        <text>åŠ è½½ä¸­...</text>
      </view>
    </view>

    <!-- è¯„è®ºåˆ—è¡¨ -->
    <view class="comment-list" tt:if="{{activeTab === 'comments' && !loading}}">
      <view 
        class="comment-item"
        tt:for="{{comments}}"
        tt:key="comment_id"
        data-index="{{index}}"
        bind:tap="viewCommentDetail"
      >
        <view class="comment-content">
          <text class="comment-text">{{item.text}}</text>
          <view class="comment-video" tt:if="{{item.item_title}}">
            <text class="video-label">è§†é¢‘:</text>
            <text class="video-name">{{item.item_title}}</text>
          </view>
        </view>
        <view class="comment-meta">
          <view class="comment-stats">
            <text class="stat-item">ğŸ‘ {{item.digg_count}}</text>
            <text class="stat-item">ğŸ’¬ {{item.reply_count}}</text>
            <text class="top-badge" tt:if="{{item.top}}">ç½®é¡¶</text>
          </view>
          <text class="comment-time">{{formatTime(item.create_time)}}</text>
        </view>
      </view>
      
      <!-- è¯„è®ºåˆ—è¡¨ä¸ºç©º -->
      <view class="empty-state" tt:if="{{comments.length === 0 && !commentLoading}}">
        <text class="empty-icon">ğŸ’¬</text>
        <text class="empty-text">{{commentError || 'æš‚æ— è¯„è®ºæ•°æ®'}}</text>
        <text class="error-hint" tt:if="{{commentError && commentError.includes('ç½‘ç»œ')}}">
          ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œå·²åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ•°æ®æ¨¡å¼
        </text>
      </view>
      
      <!-- åŠ è½½æ›´å¤š -->
      <view class="load-more" tt:if="{{commentLoading}}">
        <text>åŠ è½½ä¸­...</text>
      </view>
    </view>

    <!-- ç§ä¿¡åˆ—è¡¨ -->
    <view class="message-list" tt:if="{{activeTab === 'messages' && !loading}}">
      <view 
        class="message-item"
        tt:for="{{messages}}"
        tt:key="message_id"
        data-index="{{index}}"
        bind:tap="viewMessageDetail"
      >
        <view class="message-avatar">
          <image src="{{item.from_user.avatar}}" mode="aspectFill"></image>
        </view>
        <view class="message-content">
          <view class="message-header">
            <text class="sender-name">{{item.from_user.nickname}}</text>
            <text class="message-time">{{formatTime(item.create_time)}}</text>
          </view>
          <text class="message-text">{{item.content}}</text>
        </view>
      </view>
      
      <!-- ç§ä¿¡åˆ—è¡¨ä¸ºç©º -->
      <view class="empty-state" tt:if="{{messages.length === 0 && !messageLoading}}">
        <text class="empty-icon">âœ‰ï¸</text>
        <text class="empty-text">{{messageError || 'æš‚æ— ç§ä¿¡æ•°æ®'}}</text>
        <text class="error-hint" tt:if="{{messageError && messageError.includes('ç½‘ç»œ')}}">
          ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œå·²åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ•°æ®æ¨¡å¼
        </text>
      </view>
      
      <!-- åŠ è½½æ›´å¤š -->
      <view class="load-more" tt:if="{{messageLoading}}">
        <text>åŠ è½½ä¸­...</text>
      </view>
    </view>

    <!-- æƒé™æµ‹è¯•æŒ‰é’® -->
    <view class="test-buttons">
      <button bindtap="testGetUserInfo" class="test-button">
        ğŸ” æµ‹è¯•user_infoæƒé™
      </button>
    </view>

    <!-- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
    <view class="user-info-section" tt:if="{{userInfo}}">
      <view class="section-header">
        <text class="section-title">ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯ (user_infoæƒé™)</text>
      </view>
      <view class="user-info-content">
        <view class="user-info-item">
          <text class="info-label">ç”¨æˆ·ID:</text>
          <text class="info-value">{{userInfo.openid || 'æœªè·å–'}}</text>
        </view>
        <view class="user-info-item">
          <text class="info-label">æ˜µç§°:</text>
          <text class="info-value">{{userInfo.nickname || 'æœªè·å–'}}</text>
        </view>
        <view class="user-info-item">
          <text class="info-label">å¤´åƒ:</text>
          <text class="info-value">{{userInfo.avatar ? 'å·²è·å–' : 'æœªè·å–'}}</text>
        </view>
        <view class="user-info-item">
          <text class="info-label">æ€§åˆ«:</text>
          <text class="info-value">{{userInfo.gender === 1 ? 'ç”·' : userInfo.gender === 2 ? 'å¥³' : 'æœªçŸ¥'}}</text>
        </view>
        <view class="user-info-item">
          <text class="info-label">åœ°åŒº:</text>
          <text class="info-value">{{userInfo.country}}-{{userInfo.province}}-{{userInfo.city}}</text>
        </view>
        <view class="user-info-item">
          <text class="info-label">è¯­è¨€:</text>
          <text class="info-value">{{userInfo.language || 'æœªè·å–'}}</text>
        </view>
      </view>
    </view>

    <!-- æƒé™æµ‹è¯•åŒºåŸŸ -->
    <view class="permission-test-section" tt:if="{{isLoggedIn && hasOAuthAuth}}">
      <view class="section-title">æƒé™æµ‹è¯•</view>
      
      <!-- user_infoæƒé™æµ‹è¯• -->
      <view class="test-card">
        <view class="test-header">
          <text class="test-title">user_infoæƒé™æµ‹è¯•</text>
          <text class="test-status {{userInfoTest.success ? 'success' : userInfoTest.error ? 'error' : ''}}">
            {{userInfoTest.status}}
          </text>
        </view>
        
        <button class="test-button" bindtap="testUserInfoPermission" disabled="{{userInfoTest.loading}}">
          {{userInfoTest.loading ? 'æµ‹è¯•ä¸­...' : 'æµ‹è¯•user_infoæƒé™'}}
        </button>
        
        <view class="test-result" tt:if="{{userInfoTest.result}}">
          <text class="result-text">{{userInfoTest.result}}</text>
        </view>
      </view>

      <!-- ma.item.dataæƒé™æµ‹è¯• -->
      <view class="test-card">
        <view class="test-header">
          <text class="test-title">ma.item.dataæƒé™æµ‹è¯•</text>
          <text class="test-status {{itemDataTest.success ? 'success' : itemDataTest.error ? 'error' : ''}}">
            {{itemDataTest.status}}
          </text>
        </view>
        
        <!-- item_idè¾“å…¥æ¡† -->
        <view class="input-group">
          <text class="input-label">è§†é¢‘item_idï¼ˆæµ‹è¯•ç”¨ï¼‰:</text>
          <input class="item-id-input" 
                 value="{{testItemId}}" 
                 bindinput="onItemIdInput" 
                 placeholder="è¯·è¾“å…¥è§†é¢‘item_idï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤æµ‹è¯•ID"/>
        </view>
        
        <button class="test-button" bindtap="testMaItemDataPermission" disabled="{{itemDataTest.loading}}">
          {{itemDataTest.loading ? 'æµ‹è¯•ä¸­...' : 'æµ‹è¯•ma.item.dataæƒé™'}}
        </button>
        
        <view class="test-result" tt:if="{{itemDataTest.result}}">
          <text class="result-text">{{itemDataTest.result}}</text>
        </view>
        
        <!-- æ˜¾ç¤ºè§†é¢‘æ•°æ®è¯¦æƒ… -->
        <view class="video-data-details" tt:if="{{itemDataTest.videoData}}">
          <view class="detail-title">è§†é¢‘åŸºç¡€æ•°æ®ï¼ˆè¿‘30å¤©ï¼‰:</view>
          <view class="data-item">ç‚¹èµæ•°: {{itemDataTest.videoData.total_like}}</view>
          <view class="data-item">è¯„è®ºæ•°: {{itemDataTest.videoData.total_comment}}</view>
          <view class="data-item">åˆ†äº«æ•°: {{itemDataTest.videoData.total_share}}</view>
          <view class="data-item">æ’­æ”¾æ•°: {{itemDataTest.videoData.total_play}}</view>
          <view class="data-item">å¹³å‡æ’­æ”¾æ—¶é•¿: {{itemDataTest.videoData.avg_play_duration}}ç§’</view>
        </view>
      </view>
    </view>
  </view>
</view> 